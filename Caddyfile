vsbuilder.techifyboost.com {
    # Serve static assets directly from disk with CORS
    handle_path /assets/* {
        root * /app/build/client/assets
        file_server
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, OPTIONS"
        }
    }

    # Reverse proxy to the app container for everything else
    handle {
        # Reverse proxy to the app container
        reverse_proxy app:3000 {
            # Disable passive health checks (we trust Docker's health check)
            lb_try_duration 0
        }
    }

    # Override response headers for iframe compatibility
    header {
        # Remove CSP from backend response and set our own
        -Content-Security-Policy
        Content-Security-Policy "frame-ancestors https://*.myshopify.com https://admin.shopify.com https://*.techifyboost.com 'self';"

        # Remove X-Frame-Options to allow framing
        -X-Frame-Options

        # Security headers
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# HTTP to HTTPS redirect
:80 {
    redir https://{host}{uri} permanent
}
